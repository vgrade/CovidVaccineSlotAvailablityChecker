# Warning
# Not for commercial usage, Do not abuse cowin api. Keep request under prescribed limit of 100 calls per IP Address/5 mins
# This is just for educational and personal use purpose. Any kind of harm or loss due to using this script will be solo responsibility of user.
# Developer bear no responsibility for any kind of loss due to using this script.

# How to SetUp
# Open following url in browser to get list of states and pick your state id : https://cdn-api.co-vin.in/api/v2/admin/location/states
# Open following url in browser  after replacing <stateid> with your state id which you got in last step. This will give id of all districts. 
# Pick the district id's where you want to  Search for vaccine. : https://cdn-api.co-vin.in/api/v2/admin/location/districts/<stateid>
# Update the district codes in $DistrictCodes variable 0n line no 22. You can provide multiple district code but load on cowin api will increase.
# Update Minimum Age in #MinAge variable on line no 23
# Update desired vaccine name in $vaccineName variable on line no 24
# Update desired vaccine dose no (eg : 1) on line no 25
# Update desire minimum slots you are looking for  on line no 26

# Note
# This will start beeping loudly and open cowin portal where you have to login and book slot manually.
# Search for vaccine on pin codes printed on powershell screen.


# Setup these variables according to your need
$DistrictCodes = 650,651   
$MinAge=45                    # 18/45
$VaccineName = "COVISHIELD"   # COVISHIELD/COVAXIN
$DoseNo = "1"                 # 1/2
$MinimumSlotes = 1            # Minimum no of slots needed together at a center
$RetryAFter = 20              # No of seconds after which it'll retry searching vaccine          

# Do not change anything after this unless you know powershell
#Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope LocalMachine
$DoseName="available_capacity_dose"+$DoseNo
[bool]$flag1=0
$MinimumSlotes =$MinimumSlotes - 1
$Header ="PinCode  Date         Dose  Type   District              CenterName"
$Message="Opened cowin portal. Please login and book your slot asap. List of centers with pin code is printed above."
$MessageNOSlotsFound="`nNo slots Found, Will check after {0} seconds. Current Time = {1}"
$MessaeSearching ="`n`nSearching for Minimum {0} slots of {1} dose no {2} for age group {3} in district code {4}"
for(1)
{
clear
$Today= Get-Date -Format "dd-MM-yyyy"
foreach($DistrictCode in $DistrictCodes)
{
$MessaeSearching -f ($MinimumSlotes+1),$VaccineName,$DoseNo,$MinAge,$DistrictCode
$URI="https://cdn-api.co-vin.in/api/v2/appointment/sessions/public/calendarByDistrict?district_id={0}&date={1}" -f $DistrictCode,$Today
$Response = Invoke-WebRequest -URI $URI
$Data = $Response.Content | ConvertFrom-Json

 
    Foreach($center in $Data.centers)
	{
		 Foreach($session in $center.sessions)
		{
		  if( ($session.$DoseName -gt $MinimumSlotes) -and ($session.vaccine -eq $VaccineName) -and ($session.min_age_limit -eq $MinAge))
		  {
    		   if($flag1 -eq 0)
    		   {
    		    $Header
    		   }
                $centerpincode=$center.pincode.ToString()
                $Date =$session.date.ToString()
                $centername =$center.name.ToString().PadRight(15,' ')
                $DosesAvailable = $session.$DoseName.ToString().PadLeft(3,'0')
                $centerfee_type =$center.fee_type.ToString()
                $centerdistrict_name =$center.district_name.PadRight(15,' ')
                $centerblock_name =$center.block_name.PadRight(15,' ')
                $centeraddress =$center.address.PadRight(50,' ')
                $centerdistrict_name=$center.district_name.ToString().PadRight(20,' ')
                $centerpincode + "   " + $Date +"   " + $DosesAvailable +  "   "+ $centerfee_type + "   " +$centerdistrict_name+"  "+ $centername
    		    $flag1=1
		  }
		}
	}
	
}
	if($flag1)
	{
		[system.Diagnostics.Process]::Start("chrome","https://selfregistration.cowin.gov.in/")
		$Message
		for(1)	
		{
		  [console]::beep(2000, 1000)
		}
	}
	else
	{
	$time=Get-Date
	$MessageNOSlotsFound -f $RetryAFter,$time 
	Start-Sleep -s $RetryAFter
	}

}
